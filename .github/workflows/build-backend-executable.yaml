name: Build Backend Executable

on:
  workflow_call:
    inputs:
      platform:
        description: "Target platform for the build"
        required: true
        type: string
  workflow_dispatch:
    inputs:
      platform:
        description: "Target platform for the build"
        required: true
        type: choice
        options:
          - linux
          - macos
          - windows

jobs:
  build-backend-linux:
    runs-on: ubuntu-latest
    if: ${{ inputs.platform == 'linux' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Build backend executable (PyInstaller)
        working-directory: backend
        run: |
          uv sync --frozen --group dev
          uv run pyinstaller --clean -F \
            --distpath dist \
            --name run-server-x86_64-unknown-linux-gnu \
            pyrb/controllers/api/main.py

      - name: Copy executable into Tauri sidecar bin/
        run: |
          mkdir -p frontend/src-tauri/bin/
          cp backend/dist/run-server-x86_64-unknown-linux-gnu frontend/src-tauri/bin/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: run-server-x86_64-unknown-linux-gnu
          path: frontend/src-tauri/bin/run-server-x86_64-unknown-linux-gnu

  build-backend-macos:
    runs-on: macos-13
    if: ${{ inputs.platform == 'macos' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Build backend executable
        working-directory: backend
        run: |
          uv sync --frozen --group dev
          uv run pyinstaller --clean -F \
            --distpath dist \
            --name run-server-x86_64-apple-darwin \
            pyrb/controllers/api/main.py

      - name: Copy executable into Tauri sidecar bin/
        run: |
          mkdir -p frontend/src-tauri/bin/
          cp backend/dist/run-server-x86_64-apple-darwin frontend/src-tauri/bin/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: run-server-x86_64-apple-darwin
          path: frontend/src-tauri/bin/run-server-x86_64-apple-darwin

  build-backend-windows:
    runs-on: windows-2019
    if: ${{ inputs.platform == 'windows' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Build backend executable
        shell: bash
        working-directory: backend
        run: |
          uv sync --frozen --group dev
          uv run pyinstaller --clean -F \
            --distpath dist \
            --name run-server-x86_64-pc-windows-msvc \
            pyrb/controllers/api/main.py

      - name: Copy executable into Tauri sidecar bin/
        shell: bash
        run: |
          mkdir -p frontend/src-tauri/bin/
          cp backend/dist/run-server-x86_64-pc-windows-msvc.exe frontend/src-tauri/bin/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: run-server-x86_64-pc-windows-msvc
          path: frontend/src-tauri/bin/run-server-x86_64-pc-windows-msvc.exe
